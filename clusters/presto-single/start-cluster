#!/bin/bash

# Script to start a single Presto server for the presto-single cluster

# Create logs directory if it doesn't exist
mkdir -p /opt/presto/logs

CLUSTER_DIR=$(dirname $0)

# Start Presto server
echo "Starting Presto server..."
PRESTO_OUTPUT=$(/opt/presto/bin/launcher start --etc-dir=${CLUSTER_DIR}/etc --server-log-file=/opt/presto/logs/server.log 2>&1)

# Extract PID from launcher output (format: "Started as 319")
PRESTO_PID=$(echo "$PRESTO_OUTPUT" | grep -oP "Started as \K[0-9]+")
if [ -n "$PRESTO_PID" ]; then
    echo $PRESTO_PID > ${CLUSTER_DIR}/presto.pid
    echo "Presto server started with PID: $PRESTO_PID"
else
    echo "Failed to extract Presto PID from output"
    exit 1
fi

# Wait a bit for coordinator to initialize
sleep 5

echo "Cluster started successfully"
echo "Presto server: http://localhost:8080"
echo "Presto server logs: /opt/presto/logs/server.log"